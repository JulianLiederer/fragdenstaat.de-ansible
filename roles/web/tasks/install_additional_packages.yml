---

- name: Install additional packages
  apt: name={{ item }} update_cache={{ update_apt_cache }} force=yes state=present
  with_items:
    - gettext
    - imagemagick
    - tesseract-ocr
    - libtesseract-dev
    - libleptonica-dev
    - poppler-utils
    - qpdf

- name: Comment out ImageMagick policy entries for PDF none
  replace:
    path: /etc/ImageMagick-6/policy.xml
    regexp: '^(  <policy domain="coder" rights="none" pattern="PDF" />)$'
    replace: '<!-- \1 -->'

- name: Add ImageMagick policy entries tmp resource and PDF read/write
  blockinfile:
    path: /etc/ImageMagick-6/policy.xml
    insertbefore: '</policymap>'
    block: |
      <policy domain="coder" rights="read | write" pattern="PDF" />
      <policy domain="resource" name="temporary-path" value="/tmp"/>
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK -->"

- name: Add ImageMagick policy entries for paths
  blockinfile:
    path: /etc/ImageMagick-6/policy.xml
    insertbefore: '</policymap>'
    block: |
      <policy domain="path" rights="read | write" pattern="{{ item }}/*" />
    marker: "<!-- {mark} ANSIBLE MANAGED BLOCK {{ item }} -->"
  with_items:
    - "{{ django_media_root }}/foi"
    - "{{ django_media_root }}/docs"

- replace:
    path: /etc/ImageMagick-6/policy.xml
    regexp: '<policy domain="coder" rights="none" pattern="PDF" />'
    replace: ''
    after: 'Start after line.*'
    backup: yes

- name: Install tesseract data
  get_url:
    url: "{{ item }}"
    # Remove tessdata here for tesseract > 4 in Ubuntu 18.04
    dest: "{{ tesseract_data_path }}tessdata/{{ item | basename }}"
    mode: '0444'
  with_items:
    - https://raw.githubusercontent.com/tesseract-ocr/tessdata/3.04.00/deu.traineddata
  when: ansible_distribution_version == "16.04"

- name: Install tesseract 4 data
  get_url:
    url: "{{ item }}"
    dest: "{{ tesseract_data_path }}{{ item | basename }}"
    mode: '0444'
  with_items:
    - https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.00/deu.traineddata
  when: ansible_distribution_version == "18.04"

- name: Add LibreOffice repository
  apt_repository: repo="ppa:libreoffice/libreoffice-5-3" state=present
  when: ansible_distribution_version == "16.04"

- name: Add LibreOffice repository
  apt_repository: repo="ppa:libreoffice/libreoffice-6-0" state=present
  when: ansible_distribution_version == "18.04"

- name: Install LibreOffice
  apt: name=libreoffice state=latest update_cache=yes

- name: Install Latex for PDF generation
  apt: name={{ item }} update_cache={{ update_apt_cache }} force=yes state=present
  with_items:
    - texlive
    - texlive-xetex
    - texlive-lang-german
    - latexmk
